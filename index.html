<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional HTML Code Encryptor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* [START CSS] */
        :root {
            --primary: #007bff;
            --primary-light: #00c1ff;
            --dark-bg: #1e1e1e;
            --card-bg: #2d2d2d;
            --text-light: #e0e0e0;
            --text-dark: #f8f9fa;
            --border-color: #3a3a3a;
            --success: #28a745;
            --error: #dc3545;
            --warning: #ffc107;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: var(--primary-light);
            margin-bottom: 10px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            color: #aaa;
            transition: all 0.3s;
            font-weight: 600;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-light);
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #1a1a1a;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Main App Container */
        .main-app {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .main-app.active {
            display: flex;
        }

        .auth-bar {
            width: 100%;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn i {
            font-size: 12px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            position: relative;
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary);
        }

        .logout-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg);
            overflow: hidden;
        }

        /* App UI Components */
        .header {
            background-color: var(--dark-bg);
            color: var(--text-dark);
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid var(--primary-light);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .content {
            flex: 1;
            padding: 20px;
            background-color: #222;
            overflow-y: auto;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .tabs {
            display: flex;
            background-color: #333;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: #aaa;
        }
        
        .tab.active {
            background-color: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            resize: vertical;
            background-color: #1a1a1a;
            color: #00c1ff;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
        }
        
        .btn-primary { background-color: var(--primary); }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #555; }
        .btn-secondary:hover { background-color: #444; }
        .btn-success { background-color: var(--success); }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: var(--error); width: auto; padding: 5px 15px; margin-top: 0; }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        .action-buttons .btn {
            margin-top: 0;
            flex: 1;
        }

        .footer {
            padding: 15px 20px;
            text-align: center;
            color: #666;
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            background-color: #1a1a1a;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: white;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .notification.success { background-color: var(--success); }
        .notification.error { background-color: var(--error); }
        .notification.warning { background-color: var(--warning); color: var(--dark-bg); }
        .notification.show { transform: translateX(-50%) translateY(0); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Code Items - Updated Layout */
        .codes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .codes-table th {
            background: #333;
            padding: 15px;
            text-align: left;
            color: var(--primary-light);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        .codes-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .codes-table tr:last-child td {
            border-bottom: none;
        }

        .codes-table tr:hover {
            background: #252525;
        }

        .code-date {
            color: #888;
            font-size: 13px;
            white-space: nowrap;
        }

        .code-preview {
            font-family: 'Courier Prime', monospace;
            font-size: 12px;
            color: #00c1ff;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .table-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .view-btn {
            background: var(--primary);
            color: white;
        }

        .view-btn:hover {
            background: #0056b3;
        }

        .preview-btn {
            background: #555;
            color: white;
        }

        .preview-btn:hover {
            background: #444;
        }

        .delete-btn {
            background: var(--error);
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .no-codes {
            text-align: center;
            padding: 40px;
            color: #888;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .no-codes i {
            font-size: 40px;
            margin-bottom: 15px;
            color: #555;
        }

        /* Preview Modal */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100001;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .preview-content {
            background: white;
            width: 95%;
            height: 95%;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .preview-header {
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-iframe {
            width: 100%;
            height: calc(100% - 50px);
            border: none;
        }

        .close-preview {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .close-preview:hover {
            background: #c82333;
        }

        /* Code View Modal */
        .code-view-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100002;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: slideUp 0.3s ease-out;
        }

        .code-view-content {
            background: var(--card-bg);
            width: 95%;
            height: 95%;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: scaleIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .code-view-header {
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-view-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .code-view-textarea {
            width: 100%;
            height: calc(100% - 60px);
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            background-color: #1a1a1a;
            color: #00c1ff;
            resize: none;
        }

        .code-view-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        /* Profile Dropdown */
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            min-width: 250px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-info img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--primary);
        }

        .profile-details h3 {
            margin: 0;
            color: var(--primary-light);
        }

        .profile-details p {
            margin: 5px 0 0;
            color: #888;
            font-size: 14px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .profile-stat {
            text-align: center;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 6px;
        }

        .profile-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-light);
        }

        .profile-stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab {
                padding: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }

            .codes-table {
                display: block;
                overflow-x: auto;
            }

            .codes-table th,
            .codes-table td {
                padding: 10px;
                font-size: 12px;
            }

            .table-actions {
                flex-direction: column;
                gap: 5px;
            }

            .table-btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            .left-controls {
                gap: 10px;
            }

            .refresh-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        /* [END CSS] */
    </style>
</head>
<body>

    <!-- Login/Register Page -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <div class="login-header">
                <h1><i class="fas fa-user-secret"></i> Code Security Suite</h1>
                <p>Sign in to access the HTML Encryptor</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" data-auth-tab="login">Login</div>
                <div class="auth-tab" data-auth-tab="register">Register</div>
            </div>
            
            <!-- Login Form -->
            <div class="auth-form active" id="login-form">
                <div class="form-group">
                    <label for="login-email">Email Address</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <button class="btn btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </div>
            
            <!-- Register Form -->
            <div class="auth-form" id="register-form">
                <div class="form-group">
                    <label for="register-name">Full Name</label>
                    <input type="text" id="register-name" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="register-email">Email Address</label>
                    <input type="email" id="register-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="register-confirm-password">Confirm Password</label>
                    <input type="password" id="register-confirm-password" placeholder="Confirm your password">
                </div>
                <button class="btn btn-primary" id="registerBtn">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <div class="auth-bar">
            <div class="left-controls">
                <button class="refresh-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="user-profile" id="userProfile">
                <img id="userImg" src="" alt="User">
                <span id="userName">User</span>
                <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-info">
                        <img id="profileImg" src="" alt="Profile">
                        <div class="profile-details">
                            <h3 id="profileName">User Name</h3>
                            <p id="profileEmail">user@example.com</p>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="totalCodes">0</div>
                            <div class="profile-stat-label">Total Codes</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="memberSince">0</div>
                            <div class="profile-stat-label">Member Since</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-container">
            <div class="header">
                <h1 class="app-title"><i class="fas fa-user-secret"></i> Code Security Suite</h1>
                <p class="app-subtitle">HTML Encryptor: Protect source code from casual inspection.</p>
            </div>
            
            <div class="content">
                <div class="tabs">
                    <div class="tab active" data-tab="input">Input Source</div>
                    <div class="tab" data-tab="output">Encrypted Output</div>
                    <div class="tab" data-tab="history">My Codes</div>
                </div>
                
                <div class="tab-content active" id="input-tab">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-terminal"></i> Paste HTML Code</h3>
                        <textarea id="htmlInput" placeholder="Paste your HTML code here..."></textarea>
                        <button class="btn btn-primary" id="encryptBtn">
                            <i class="fas fa-shield-alt"></i> Encrypt & Save
                        </button>
                    </div>
                </div>
                
                <div class="tab-content" id="output-tab">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-lock"></i> Encrypted Code</h3>
                        <textarea id="encryptedOutput" placeholder="Encrypted HTML will appear here..." readonly></textarea>
                        <div class="action-buttons">
                            <button class="btn btn-success" id="copyBtn">
                                <i class="fas fa-copy"></i> Copy to Clipboard
                            </button>
                            <button class="btn btn-secondary" id="previewBtn">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="history-tab">
                    <div class="card">
                        <h3 class="card-title"><i class="fas fa-history"></i> My Encrypted Codes</h3>
                        <div id="userCodesContainer">
                            <!-- Updated table layout will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>Code Security Suite &copy; 2024 | Firebase Enabled</p>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-header">
                <span><i class="fas fa-eye"></i> Code Preview</span>
                <button class="close-preview" id="closePreviewBtn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            <iframe id="previewIframe" class="preview-iframe"></iframe>
        </div>
    </div>

    <!-- Code View Modal -->
    <div class="code-view-modal" id="codeViewModal">
        <div class="code-view-content">
            <div class="code-view-header">
                <span><i class="fas fa-code"></i> Full Code View</span>
                <button class="close-preview" id="closeCodeViewBtn">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
            <div class="code-view-body">
                <textarea id="codeViewTextarea" class="code-view-textarea" readonly></textarea>
                <div class="code-view-actions">
                    <button class="btn btn-success" id="copyCodeBtn">
                        <i class="fas fa-copy"></i> Copy Code
                    </button>
                    <button class="btn btn-primary" id="previewCodeBtn">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span>Action successful!</span>
    </div>

    <script type="module">
        // Import Firebase Functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, serverTimestamp, deleteDoc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCV7v8pnX3ugFmf29D07Y4M7Ekvja0KVEA",
            authDomain: "html-encrypt.firebaseapp.com",
            projectId: "html-encrypt",
            storageBucket: "html-encrypt.firebasestorage.app",
            messagingSenderId: "324943934804",
            appId: "1:324943934804:web:24d099afc67828566504c1"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase Init Error:", e);
            alert("Firebase configuration error!");
        }

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const mainApp = document.getElementById('mainApp');
        const authTabs = document.querySelectorAll('.auth-tab');
        const authForms = document.querySelectorAll('.auth-form');
        
        // Login Form Elements
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('loginBtn');
        
        // Register Form Elements
        const registerName = document.getElementById('register-name');
        const registerEmail = document.getElementById('register-email');
        const registerPassword = document.getElementById('register-password');
        const registerConfirmPassword = document.getElementById('register-confirm-password');
        const registerBtn = document.getElementById('registerBtn');

        // Main App Elements
        const userImg = document.getElementById('userImg');
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const userCodesContainer = document.getElementById('userCodesContainer');
        const previewModal = document.getElementById('previewModal');
        const closePreviewBtn = document.getElementById('closePreviewBtn');
        const previewIframe = document.getElementById('previewIframe');
        
        // Profile Elements
        const userProfile = document.getElementById('userProfile');
        const profileDropdown = document.getElementById('profileDropdown');
        const profileImg = document.getElementById('profileImg');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const totalCodes = document.getElementById('totalCodes');
        const memberSince = document.getElementById('memberSince');
        
        // Code View Modal Elements
        const codeViewModal = document.getElementById('codeViewModal');
        const closeCodeViewBtn = document.getElementById('closeCodeViewBtn');
        const codeViewTextarea = document.getElementById('codeViewTextarea');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const previewCodeBtn = document.getElementById('previewCodeBtn');

        // Global Variables
        let currentUser = null;
        let userCodes = [];

        // Notification Helper
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('i');
            const text = notification.querySelector('span');
            text.textContent = message;
            notification.className = 'notification';
            if (type === 'error') {
                notification.classList.add('error');
                icon.className = 'fas fa-exclamation-triangle';
            } else if (type === 'warning') {
                notification.classList.add('warning');
                icon.className = 'fas fa-exclamation-triangle';
            } else {
                notification.classList.add('success');
                icon.className = 'fas fa-check-circle';
            }
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Refresh Button Functionality
        refreshBtn.addEventListener('click', () => {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
            loadUserCodes();
            setTimeout(() => {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                showNotification('Codes refreshed successfully!');
            }, 1000);
        });

        // Profile Dropdown Toggle
        userProfile.addEventListener('click', (e) => {
            if (!e.target.closest('.logout-btn')) {
                profileDropdown.classList.toggle('show');
            }
        });

        // Close profile dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-profile')) {
                profileDropdown.classList.remove('show');
            }
        });

        // Auth Tab Switching
        authTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-auth-tab');
                authTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                authForms.forEach(f => f.classList.remove('active'));
                document.getElementById(`${tabId}-form`).classList.add('active');
            });
        });

        // LOGIN FUNCTION
        loginBtn.addEventListener('click', () => {
            const email = loginEmail.value.trim();
            const password = loginPassword.value;
            
            if (!email || !password) {
                showNotification('Please enter both email and password', 'error');
                return;
            }
            
            signInWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    const user = userCredential.user;
                    showNotification(`Welcome back!`);
                    
                    // Update last login
                    await setDoc(doc(db, "users", user.uid), {
                        lastLogin: serverTimestamp()
                    }, { merge: true });
                })
                .catch((error) => {
                    let errorMessage = 'Login failed';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = 'User not found. Please register first.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Incorrect password. Please try again.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email format.';
                    }
                    showNotification(errorMessage, 'error');
                });
        });

        // REGISTER FUNCTION
        registerBtn.addEventListener('click', () => {
            const name = registerName.value.trim();
            const email = registerEmail.value.trim();
            const password = registerPassword.value;
            const confirmPassword = registerConfirmPassword.value;
            
            if (!name || !email || !password || !confirmPassword) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }
            
            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    const user = userCredential.user;
                    showNotification(`Registration successful! Welcome, ${name}!`);
                    
                    // Save User to Firestore
                    await setDoc(doc(db, "users", user.uid), {
                        name: name,
                        email: user.email,
                        photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=007bff&color=fff`,
                        status: 'active',
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    });
                })
                .catch((error) => {
                    let errorMessage = 'Registration failed';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already in use. Please login instead.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email format.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak. Please use a stronger password.';
                    }
                    showNotification(errorMessage, 'error');
                });
        });

        // LOGOUT FUNCTION
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                showNotification('Signed out successfully');
                currentUser = null;
            });
        });

        // AUTH STATE LISTENER
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginPage.style.display = 'none';
                mainApp.classList.add('active');
                
                // Get user data
                const userRef = doc(db, "users", user.uid);
                getDoc(userRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        const name = userData.name || user.email;
                        userName.textContent = name;
                        userImg.src = userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=007bff&color=fff`;
                        
                        // Update profile dropdown
                        profileName.textContent = name;
                        profileEmail.textContent = userData.email || user.email;
                        profileImg.src = userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=007bff&color=fff`;
                        
                        // Update member since
                        if (userData.createdAt) {
                            const date = new Date(userData.createdAt.seconds * 1000);
                            memberSince.textContent = date.getFullYear();
                        }
                    } else {
                        userName.textContent = user.email;
                        userImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=007bff&color=fff`;
                        profileName.textContent = user.email;
                        profileEmail.textContent = user.email;
                        profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=007bff&color=fff`;
                    }
                }).catch((error) => {
                    console.error("Error getting user data:", error);
                    userName.textContent = user.email;
                    userImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=007bff&color=fff`;
                });
                
                // Load user codes
                loadUserCodes();
            } else {
                currentUser = null;
                loginPage.style.display = 'flex';
                mainApp.classList.remove('active');
            }
        });

        // ENCRYPTION FUNCTION
        document.getElementById('encryptBtn').addEventListener('click', async () => {
            const htmlInput = document.getElementById('htmlInput');
            const encryptedOutput = document.getElementById('encryptedOutput');
            const inputHTML = htmlInput.value.trim();

            if (!inputHTML) {
                showNotification('Please enter HTML to encrypt.', 'error');
                return;
            }

            const encryptBtn = document.getElementById('encryptBtn');
            encryptBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Processing...';
            
            setTimeout(() => {
                let base64 = btoa(unescape(encodeURIComponent(inputHTML)));
                const encrypted = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Secure Page</title>
<style>body{margin:0;padding:0;background:#1e1e1e;display:flex;justify-content:center;align-items:center;height:100vh;color:#00c1ff;font-family:sans-serif;}
.spinner{width:50px;height:50px;border:5px solid rgba(0,193,255,0.2);border-top:5px solid #00c1ff;border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style>
</head><body><div id="l"><div class="spinner"></div><p>Decrypting...</p></div>
<script>var e='${base64}';var d=decodeURIComponent(escape(atob(e)));document.getElementById('l').remove();document.write(d);<\/script></body></html>`;
                
                encryptedOutput.value = encrypted;
                encryptBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Encrypt & Save';
                
                // Save to Firestore
                if (currentUser) {
                    const codeData = {
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        originalCode: inputHTML,
                        encryptedCode: encrypted,
                        createdAt: serverTimestamp()
                    };
                    
                    const codeRef = doc(collection(db, "codes"));
                    setDoc(codeRef, codeData).then(() => {
                        showNotification('HTML Encrypted and saved!');
                        loadUserCodes();
                    }).catch((error) => {
                        console.error("Error saving code:", error);
                        showNotification('Error saving code', 'error');
                    });
                }
                
                document.querySelector('.tab[data-tab="output"]').click();
            }, 800);
        });

        // Load User Codes with Table Layout
        async function loadUserCodes() {
            if (!currentUser) return;
            
            try {
                // First get all codes for the user without ordering
                const codesQuery = query(
                    collection(db, "codes"), 
                    where("userId", "==", currentUser.uid)
                );
                const querySnapshot = await getDocs(codesQuery);
                
                if (querySnapshot.empty) {
                    userCodesContainer.innerHTML = `
                        <div class="no-codes">
                            <i class="fas fa-code"></i>
                            <h3>No Encrypted Codes Found</h3>
                            <p>Encrypt some HTML code to see them here.</p>
                        </div>
                    `;
                    userCodes = [];
                    totalCodes.textContent = '0';
                    return;
                }
                
                // Convert to array and sort client-side
                let codes = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    codes.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                // Sort by createdAt descending (newest first) client-side
                codes.sort((a, b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });
                
                userCodes = codes;
                totalCodes.textContent = codes.length;
                
                // Build Table HTML
                let html = `
                    <table class="codes-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Code Preview</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                codes.forEach((code) => {
                    const date = code.createdAt ? new Date(code.createdAt.seconds * 1000).toLocaleString() : 'N/A';
                    const preview = code.originalCode.substring(0, 50) + (code.originalCode.length > 50 ? '...' : '');
                    
                    html += `
                        <tr>
                            <td class="code-date">${date}</td>
                            <td class="code-preview" title="${code.originalCode.replace(/"/g, '&quot;')}">${preview}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="table-btn view-btn" onclick="viewCode('${code.id}')">
                                        <i class="fas fa-eye"></i> View Full Code
                                    </button>
                                    <button class="table-btn preview-btn" onclick="previewCode('${code.id}')">
                                        <i class="fas fa-desktop"></i> Preview
                                    </button>
                                    <button class="table-btn delete-btn" onclick="deleteCode('${code.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                userCodesContainer.innerHTML = html;
            } catch (error) {
                console.error("Error loading user codes:", error);
                showNotification('Error loading codes', 'error');
            }
        }

        // View Code
        window.viewCode = async function(codeId) {
            const code = userCodes.find(c => c.id === codeId);
            if (code) {
                codeViewTextarea.value = code.encryptedCode;
                codeViewModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        };

        // Preview Code from History
        window.previewCode = async function(codeId) {
            const code = userCodes.find(c => c.id === codeId);
            if (code) {
                previewIframe.srcdoc = code.encryptedCode;
                previewModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        };

        // Delete Code
        window.deleteCode = async function(codeId) {
            if (!confirm('Are you sure you want to delete this code?')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, "codes", codeId));
                showNotification('Code deleted successfully!');
                loadUserCodes();
            } catch (error) {
                console.error("Error deleting code:", error);
                showNotification('Error deleting code', 'error');
            }
        };

        // Copy Logic
        document.getElementById('copyBtn').addEventListener('click', () => {
            const out = document.getElementById('encryptedOutput');
            if(out.value) { 
                out.select(); 
                document.execCommand('copy'); 
                showNotification('Copied to clipboard!'); 
            }
        });

        // Copy Code from Modal
        copyCodeBtn.addEventListener('click', () => {
            codeViewTextarea.select();
            document.execCommand('copy');
            showNotification('Code copied to clipboard!');
        });

        // Preview Code from Modal
        previewCodeBtn.addEventListener('click', () => {
            const code = codeViewTextarea.value;
            if (code) {
                previewIframe.srcdoc = code;
                previewModal.style.display = 'flex';
            }
        });

        // Tab Logic
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach(c => c.classList.remove('active'));
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // Preview Button (Fixed)
        document.getElementById('previewBtn').addEventListener('click', () => {
            const encryptedCode = document.getElementById('encryptedOutput').value;
            if (encryptedCode) {
                previewIframe.srcdoc = encryptedCode;
                previewModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                showNotification('No code to preview', 'error');
            }
        });

        // Close Preview Modal
        closePreviewBtn.addEventListener('click', () => {
            previewModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });

        // Close Code View Modal
        closeCodeViewBtn.addEventListener('click', () => {
            codeViewModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });

        // Close modals when clicking outside
        previewModal.addEventListener('click', (e) => {
            if (e.target === previewModal) {
                previewModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        codeViewModal.addEventListener('click', (e) => {
            if (e.target === codeViewModal) {
                codeViewModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    </script>
</body>
</html>